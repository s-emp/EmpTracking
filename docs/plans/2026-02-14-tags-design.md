# Система тегов для EmpTracking

## Обзор

Добавляем возможность назначать теги приложениям и сессиям. Тег = имя + два цвета (светлая/тёмная тема). У приложения — дефолтный тег. У сессии — переопределяемый тег (если не задан, наследуется от приложения).

## Модель данных

### Новая таблица `tags`

```sql
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    color_light TEXT NOT NULL,
    color_dark TEXT NOT NULL
);
```

### Изменения существующих таблиц

```sql
ALTER TABLE apps ADD COLUMN default_tag_id INTEGER REFERENCES tags(id);
ALTER TABLE activity_logs ADD COLUMN tag_id INTEGER REFERENCES tags(id);
```

### Новая модель

```swift
struct Tag {
    let id: Int
    let name: String
    let colorLight: String  // hex
    let colorDark: String   // hex
}

struct TagSummary {
    let tag: Tag?           // nil = "Без тега"
    let totalDuration: TimeInterval
}
```

### Логика резолва тега сессии

`activity_logs.tag_id ?? apps.default_tag_id ?? nil`

## DatabaseManager

### Миграция

При запуске проверяем существование таблицы `tags`. Если нет — создаём таблицу и добавляем колонки через `ALTER TABLE`. Существующие данные работают без изменений (все теги = null = «Без тега»).

### Новые методы

- `createTag(name:colorLight:colorDark:) → Tag`
- `updateTag(id:name:colorLight:colorDark:)`
- `deleteTag(id:)` — обнуляет `default_tag_id` и `tag_id` где использовался
- `fetchAllTags() → [Tag]`
- `setDefaultTag(appId:tagId:)` — дефолтный тег приложения
- `setSessionTag(logId:tagId:)` — переопределение тега сессии (nil = вернуть к дефолту)
- `fetchTagSummaries(from:to:) → [TagSummary]` — агрегация времени по тегам за период

## UI — Поповер (TimelineView)

### Сегмент «Приложения / Теги»

Заменяет «День / Неделя / Месяц». Данные всегда за сегодня.

- **Режим «Приложения»**: список приложений с иконкой, именем, длительностью (как раньше).
- **Режим «Теги»**: список тегов — цветная точка + имя + суммарное время. Строка «Без тега» внизу.

### Управление тегами приложения

Клик по строке приложения (режим «Приложения») → NSMenu:
- Список тегов (цветная точка + имя), текущий отмечен галочкой
- «Без тега» для сброса
- Разделитель
- «Создать тег...» → инлайн-форма

### Создание тега (инлайн-форма)

- Текстовое поле для имени
- Два NSColorWell (светлая / тёмная тема)
- Кнопки «Создать» / «Отмена»

## UI — Окно «Подробнее» (DetailView)

### Сегмент «Приложения / Теги»

Добавляется сверху. Остальной UI не трогаем, кардинальная переработка позже.

### Назначение тега сессии

Клик по строке сессии → NSMenu:
- Список тегов (цветная точка + имя), текущий отмечен галочкой
- «Тег приложения» — сбросить переопределение (tag_id = null)
- «Без тега» — явно убрать тег
- Разделитель
- «Создать тег...»

В строке сессии — цветная точка resolved тега. Если тег переопределён вручную — точка с обводкой.

## Граничные случаи

- **Удаление тега**: обнуляет ссылки, записи становятся «Без тега»
- **Дублирование имени**: UNIQUE constraint, ошибка в инлайн-форме
- **Новое приложение**: default_tag_id = null, назначается вручную
- **Смена темы**: цвета перерисовываются через NSApp.effectiveAppearance
- **Миграция**: ALTER TABLE для существующих БД, данные без потерь
